<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Travel | 萬用旅遊助手</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Noto+Sans+TC:wght@300;400;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #F9FAFB; }
        .setup-gradient { background: linear-gradient(135deg, #134E4A 0%, #065F46 100%); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen relative shadow-2xl bg-white overflow-x-hidden">

<div id="app">
    <div v-if="!isSetup" class="fixed inset-0 z-[9999] setup-gradient p-8 text-white flex flex-col justify-center">
        <div class="mb-8">
            <h1 class="text-4xl font-bold mb-2">Global Travel</h1>
            <p class="opacity-70 italic text-sm font-light">開啟你的下一個探險...</p>
        </div>

        <div class="space-y-6">
            <div>
                <label class="text-[10px] uppercase tracking-widest opacity-60 font-bold">旅程標題</label>
                <input v-model="config.title" placeholder="例如：我的畢業旅行" class="w-full bg-white/10 border-b border-white/30 p-3 outline-none focus:border-white transition-all text-lg">
            </div>

            <div>
                <label class="text-[10px] uppercase tracking-widest opacity-60 font-bold">目的地 (英文)</label>
                <input v-model="config.destination" @blur="autoDetect" placeholder="例如：Tokyo, London, Paris" class="w-full bg-white/10 border-b border-white/30 p-3 outline-none focus:border-white transition-all text-lg uppercase tracking-tighter">
                <p v-if="detectedInfo" class="text-[11px] mt-2 text-emerald-300">
                    <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> 
                    偵測到：{{ detectedInfo.currency }} / {{ detectedInfo.langName }}
                </p>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] uppercase tracking-widest opacity-60 font-bold">出發日期</label>
                    <input v-model="config.startDate" type="date" class="w-full bg-white/10 border-b border-white/30 p-3 outline-none text-sm">
                </div>
                <div>
                    <label class="text-[10px] uppercase tracking-widest opacity-60 font-bold">天數</label>
                    <input v-model.number="config.days" type="number" class="w-full bg-white/10 border-b border-white/30 p-3 outline-none text-sm">
                </div>
            </div>

            <button @click="startTrip" class="w-full bg-white text-teal-900 py-4 rounded-2xl font-bold text-lg shadow-xl active:scale-95 transition-transform">
                生成專屬行程 <i class="fa-solid fa-arrow-right ml-2"></i>
            </button>
        </div>
    </div>

    <div v-else class="pb-24 animate-fadeIn">
        <header class="p-6 bg-white sticky top-0 z-50">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-2xl font-black text-slate-800 tracking-tight">{{ config.title }}</h2>
                    <p class="text-xs text-teal-600 font-medium tracking-widest uppercase">{{ config.destination }}</p>
                </div>
                <div class="text-right">
                    <div class="bg-slate-100 px-3 py-1 rounded-full text-[10px] font-bold text-slate-500">
                        1 {{ config.currency }} ≈ {{ exchangeRate.toFixed(4) }} HKD
                    </div>
                </div>
            </div>

            <div class="flex overflow-x-auto space-x-3 no-scrollbar">
                <div v-for="d in generatedDays" :key="d.full" 
                     @click="selectedDate = d.full"
                     :class="selectedDate === d.full ? 'bg-teal-800 text-white shadow-lg scale-105' : 'bg-slate-50 text-slate-400'"
                     class="flex-shrink-0 w-14 h-16 rounded-2xl flex flex-col items-center justify-center transition-all cursor-pointer border border-slate-100">
                    <span class="text-[9px] uppercase font-bold">{{ d.weekday }}</span>
                    <span class="text-base font-black">{{ d.day }}</span>
                </div>
            </div>
        </header>

        <main class="px-6">
            <div class="mb-6 bg-slate-900 rounded-3xl p-5 text-white shadow-xl relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-3 opacity-60">
                        <i class="fa-solid fa-language text-xs"></i>
                        <span class="text-[10px] font-bold uppercase tracking-widest">快速翻譯 ({{ config.langName }})</span>
                    </div>
                    <div class="space-y-3">
                        <input v-model="translateText" @keyup.enter="doTranslate" placeholder="輸入中文..." class="w-full bg-white/10 p-3 rounded-xl outline-none text-sm border border-white/10">
                        <div v-if="translatedResult" class="p-3 bg-emerald-500/20 rounded-xl border border-emerald-500/30">
                            <p class="text-xs text-emerald-300 mb-1 leading-none">翻譯結果：</p>
                            <p class="text-lg font-medium">{{ translatedResult }}</p>
                        </div>
                    </div>
                </div>
                <i class="fa-solid fa-earth-asia absolute -right-4 -bottom-4 text-7xl opacity-10"></i>
            </div>

            <section v-if="activeTab === 'itinerary'" class="space-y-4">
                <div v-for="(item, index) in filteredItinerary" :key="index" class="group bg-white p-4 rounded-2xl border border-slate-100 shadow-sm hover:border-teal-200 transition-colors">
                    <div class="flex justify-between items-center mb-2">
                        <input v-model="item.time" type="time" class="text-xs font-black text-teal-700 outline-none">
                        <button @click="removeItinerary(index)" class="text-slate-200 group-hover:text-red-400 transition-colors"><i class="fa-solid fa-circle-xmark"></i></button>
                    </div>
                    <input v-model="item.location" @change="saveToFirebase" class="w-full font-bold text-slate-700 outline-none bg-transparent" placeholder="輸入目的地...">
                </div>
                <button @click="addItinerary" class="w-full py-4 rounded-2xl border-2 border-dashed border-slate-100 text-slate-400 text-sm font-bold hover:bg-slate-50">+ Add Spot</button>
            </section>

            <section v-if="activeTab === 'split'" class="space-y-4">
                <div class="bg-white rounded-3xl p-6 border border-slate-100 shadow-sm">
                    <div class="flex gap-2 mb-4">
                        <input v-model.number="newExpense.amount" type="number" :placeholder="'金額 ('+config.currency+')'" class="flex-1 p-3 bg-slate-50 rounded-xl outline-none text-sm">
                        <div class="p-3 bg-teal-50 rounded-xl text-teal-700 font-bold text-sm">≈ HKD {{ (newExpense.amount * exchangeRate).toFixed(1) }}</div>
                    </div>
                    <button @click="addExpense" class="w-full bg-teal-800 text-white py-4 rounded-2xl font-bold">記錄同步</button>
                </div>
                <div v-for="b in balances" class="p-4 bg-slate-50 rounded-2xl flex justify-between items-center border border-white">
                    <span class="text-xs font-bold">{{b.from}} ➜ {{b.to}}</span>
                    <span class="text-sm font-black text-teal-700">HKD ${{ (b.amount * exchangeRate).toFixed(1) }}</span>
                </div>
            </section>
        </main>

        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto glass-nav py-4 px-12 flex justify-between border-t border-slate-100 z-50">
            <button @click="activeTab = 'itinerary'" :class="activeTab === 'itinerary' ? 'text-teal-800 scale-110' : 'text-slate-300'"><i class="fa-solid fa-map-pin text-xl"></i></button>
            <button @click="activeTab = 'split'" :class="activeTab === 'split' ? 'text-teal-800 scale-110' : 'text-slate-300'"><i class="fa-solid fa-wallet text-xl"></i></button>
            <button @click="resetConfig" class="text-slate-300"><i class="fa-solid fa-gear text-xl"></i></button>
        </nav>
    </div>
</div>

<script>
// --- Firebase 配置 (請填寫你自己的) ---
const firebaseConfig = { apiKey: "AIza...", ... }; 
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const { createApp, ref, computed, onMounted } = Vue;

createApp({
    setup() {
        const isSetup = ref(false);
        const activeTab = ref('itinerary');
        const selectedDate = ref('');
        const translateText = ref('');
        const translatedResult = ref('');
        const exchangeRate = ref(0);

        const config = ref({
            title: '',
            destination: '',
            startDate: '',
            days: 5,
            currency: 'USD',
            langCode: 'en',
            langName: '英文'
        });

        const itinerary = ref([]);
        const expenses = ref([]);
        const members = ref(['我', '夥伴A', '夥伴B']);
        const newExpense = ref({ amount: 0, payer: '我' });

        // 自動偵測資料庫 (根據地名關鍵字)
        const autoDetect = () => {
            const dest = config.value.destination.toLowerCase();
            const dict = {
                'tokyo': { cur: 'JPY', lang: 'ja', name: '日文', country: 'Japan' },
                'osaka': { cur: 'JPY', lang: 'ja', name: '日文', country: 'Japan' },
                'london': { cur: 'GBP', lang: 'en', name: '英文', country: 'UK' },
                'paris': { cur: 'EUR', lang: 'fr', name: '法文', country: 'France' },
                'seoul': { cur: 'KRW', lang: 'ko', name: '韓文', country: 'Korea' },
                'bangkok': { cur: 'THB', lang: 'th', name: '泰文', country: 'Thailand' }
            };
            
            for (let key in dict) {
                if (dest.includes(key)) {
                    config.value.currency = dict[key].cur;
                    config.value.langCode = dict[key].lang;
                    config.value.langName = dict[key].name;
                    return;
                }
            }
        };

        const detectedInfo = computed(() => config.value.currency ? config.value : null);

        // 生成日期數組
        const generatedDays = computed(() => {
            if (!config.value.startDate) return [];
            const result = [];
            let start = new Date(config.value.startDate);
            for (let i = 0; i < config.value.days; i++) {
                let d = new Date(start);
                d.setDate(start.getDate() + i);
                result.push({
                    full: d.toISOString().split('T')[0],
                    day: d.getDate(),
                    weekday: d.toLocaleDateString('en-US', { weekday: 'short' })
                });
            }
            return result;
        });

        const startTrip = async () => {
            if (!config.value.title || !config.value.destination) return alert('請填寫完整資訊');
            
            // 抓取即時匯率 (對 HKD)
            try {
                const res = await fetch(`https://api.exchangerate-api.com/v4/latest/${config.value.currency}`);
                const data = await res.json();
                exchangeRate.value = data.rates.HKD;
            } catch (e) { exchangeRate.value = 1; }

            selectedDate.value = config.value.startDate;
            isSetup.value = true;
            saveToFirebase();
        };

        // 模擬翻譯功能 (實際可接 MyMemory API)
        const doTranslate = async () => {
            if (!translateText.value) return;
            const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(translateText.value)}&langpair=zh-TW|${config.value.langCode}`);
            const data = await res.json();
            translatedResult.value = data.responseData.translatedText;
        };

        const filteredItinerary = computed(() => itinerary.value.filter(i => i.date === selectedDate.value));

        const addItinerary = () => {
            itinerary.value.push({ date: selectedDate.value, time: '12:00', location: '' });
            saveToFirebase();
        };

        const addExpense = () => {
            if (newExpense.value.amount > 0) {
                expenses.value.push({ ...newExpense.value });
                newExpense.value.amount = 0;
                saveToFirebase();
            }
        };

        const saveToFirebase = () => {
            db.ref('universalTrip').set({
                config: config.value,
                itinerary: itinerary.value,
                expenses: expenses.value,
                exchangeRate: exchangeRate.value
            });
        };

        const resetConfig = () => { if(confirm('重設將清除所有設定，確定嗎？')) isSetup.value = false; };

        return {
            isSetup, config, autoDetect, detectedInfo, startTrip, generatedDays, selectedDate,
            activeTab, translateText, translatedResult, doTranslate, exchangeRate,
            itinerary, filteredItinerary, addItinerary, expenses, newExpense, addExpense,
            saveToFirebase, resetConfig, balances: computed(() => []) // 分帳邏輯同前
        }
    }
}).mount('#app')
</script>
</body>
</html>
